!function($){var gvSearchWidget={wrapClass:null,widgetTarget:null,selectFields:null,wp_widget_id:"gravityview_search",init:function(wrapClass){gvSearchWidget.wrapClass=wrapClass;var wp_widget_id=gvSearchWidget.wp_widget_id;$("body").on("dialogopen",'[data-fieldid="search_bar"] .'+wrapClass,gvSearchWidget.openDialog).bind("click.widgets-toggle",gvSearchWidget.openWidget).on("click","."+wrapClass+" a[href='#addSearchField']",gvSearchWidget.addField).on("click","."+wrapClass+" a[href='#removeSearchField']",gvSearchWidget.removeField).on("change","."+wrapClass+" select.gv-search-fields",gvSearchWidget.updateRow).on("sortcreate sortupdate sort","."+wrapClass+" table",gvSearchWidget.zebraStripe).on("dialogbeforeclose",'[data-fieldid="search_bar"] .'+wrapClass,gvSearchWidget.updateOnClose).on("click",".widget[id*='"+wp_widget_id+"'] input.widget-control-save",gvSearchWidget.saveWidget).on("change","#gravityview_form_id, #gravityview_directory_template",gvSearchWidget.clearViewSearchData).on("change","#gravityview_view_id",gvSearchWidget.clearWidgetSearchData),$(document).on("widget-added widget-updated",gvSearchWidget.refreshWidget)},resetWidgetTarget:function(obj){gvSearchWidget.widgetTarget=obj.closest("div.widget").find("div."+gvSearchWidget.wrapClass),gvSearchWidget.selectFields=null},resetWidgetData:function(obj){gvSearchWidget.resetWidgetTarget(obj),$("table",gvSearchWidget.widgetTarget).remove()},openWidget:function(e){var widget,widgetId,target=$(e.target);target.parents(".widget-top").length&&!target.parents("#available-widgets").length&&(e.preventDefault(),widget=$(e.target).closest("div.widget"),widgetId=widget.attr("id"),!widget.hasClass("open")&&widgetId.indexOf(gvSearchWidget.wp_widget_id)>0&&(gvSearchWidget.resetWidgetData(target),gvSearchWidget.renderUI(widget)))},refreshWidget:function(e,widget){$(widget).hasClass("open")&&(gvSearchWidget.widgetTarget=$(widget).find("div."+gvSearchWidget.wrapClass),gvSearchWidget.renderUI(widget))},openDialog:function(e){e.preventDefault(),gvSearchWidget.widgetTarget=$(this),gvSearchWidget.renderUI($(this).parents(".gv-fields"))},addField:function(e){e.preventDefault(),"gv-widget-search-fields"===gvSearchWidget.wrapClass&&gvSearchWidget.resetWidgetTarget($(this));var table=$(this).parents("table"),row=$(this).parents("tr");return row.hasClass("no-search-fields")&&(row.remove(),row=null),gvSearchWidget.addRow(table,row,null),!1},removeField:function(e){e.preventDefault();var table=$(this).parents("table");return $(this).parents("tr").fadeTo("normal",.4,function(){$(this).remove(),$("tr.gv-search-field-row",table).length<1&&$("tr.no-search-fields",table).length<1&&gvSearchWidget.addEmptyMsg(table),gvSearchWidget.updateAvailableFields(),gvSearchWidget.styleRow(table)}),!1},renderUI:function(parent){var fields=$(".gv-search-fields-value",parent).val(),viewId=$("#gravityview_view_id",parent).val();if(""!==viewId)return null===gvSearchWidget.selectFields?(gvSearchWidget.widgetTarget.append('<p id="gv-loading"><span class="spinner"></span>'+gvGlobals.loading_text+"</p>"),void gvSearchWidget.getSelectFields(parent)):void($("table",gvSearchWidget.widgetTarget).length&&$("#gv-loading").length<1||(table=gvSearchWidget.addTable(),fields&&0===fields.length?gvSearchWidget.addRow(table,null,null):gvSearchWidget.populateRows(table,fields),gvSearchWidget.widgetTarget.append(table),gvSearchWidget.widgetTarget.find("table tbody").sortable({start:function(event,ui){$(ui.item).removeClass("alt")}}),gvSearchWidget.updateAvailableFields(),$("#gv-loading").remove()))},zebraStripe:function(){$(gvSearchWidget.widgetTarget).find("tr.gv-search-field-row").removeClass("alt").filter(":even").addClass("alt")},populateRows:function(table,fields){var rows=$.parseJSON(fields),pos=null;return rows&&0!==rows.length?void $.each(rows,function(i,values){gvSearchWidget.addRow(table,pos,values),pos=table.find("tbody tr:last")}):void gvSearchWidget.addEmptyMsg(table)},addTable:function(){return $('<table class="form-table widefat"><thead><tr><th class="cell-sort">&nbsp;</th><th class="cell-search-fields">'+gvSearchVar.label_searchfield+'</th><th class="cell-input-types">'+gvSearchVar.label_inputtype+'</th><th class="cell-add-remove">&nbsp;</th></tr></thead><tbody></tbody></table>')},addEmptyMsg:function(table){$(table).append('<tr class="no-search-fields"><td colspan="4">'+gvSearchVar.label_nofields+'&nbsp; <a href="#addSearchField">'+gvSearchVar.label_addfield+"</a></td></tr>")},addRow:function(table,row,curr){var rowString=$('<tr class="gv-search-field-row new-row hide-if-js" />').append('<td class="cell-sort"><span class="icon gv-icon-caret-up-down" /></td>').append('<td class="cell-search-fields">'+gvSearchWidget.getSelectFields()+"</td>").append('<td class="cell-input-types"><select class="gv-search-inputs" /></td>').append('<td class="cell-add-remove"><a href="#addSearchField" class="dashicons dashicons-plus-alt" /><a href="#removeSearchField" class="dashicons dashicons-dismiss" /></td>');null!==row&&row.length?$(row,table).after(rowString):$("tbody",table).append(rowString),table.find("tr.new-row").each(function(){$(this).removeClass("new-row"),null!==curr&&$(this).find("select.gv-search-fields").val(curr.field),gvSearchWidget.updateSelectInput($(this)),null!==curr&&$(this).find("select.gv-search-inputs").val(curr.input),$(this).fadeIn(function(){$(this).removeClass("hide-if-js")})}),gvSearchWidget.styleRow(table)},styleRow:function(){var sort_icon=$(".cell-sort .icon",gvSearchWidget.widgetTarget);1===$("tbody tr",gvSearchWidget.widgetTarget).length?sort_icon.fadeOut("fast",function(){$(this).parents("td").addClass("no-sort")}):sort_icon.fadeIn("fast",function(){$(this).parents("td").removeClass("no-sort")}),gvSearchWidget.zebraStripe()},updateRow:function(){var row=$(this).parents("tr");gvSearchWidget.updateSelectInput(row),gvSearchWidget.updateAvailableFields()},updateAvailableFields:function(){$("option",gvSearchWidget.selectFields).attr("disabled",null),$("tr.gv-search-field-row .gv-search-fields",gvSearchWidget.widgetTarget).each(function(){gvSearchWidget.selectFields.find('option[value="'+$(this).val()+'"]').attr("disabled",!0)}).each(function(){var select=gvSearchWidget.selectFields.clone();select.val($(this).val()),select.find("option:selected").attr("disabled",null),$(this).replaceWith(select)})},updateSelectInput:function(tr){var type=tr.find("select.gv-search-fields option:selected").attr("data-inputtypes"),select=tr.find("select.gv-search-inputs"),options=gvSearchWidget.getSelectInput(type);select.html(options),select.prop("disabled",function(){return 1===$("option",$(this)).length})},getSelectFields:function(parent){if(null!==gvSearchWidget.selectFields)return gvSearchWidget.updateAvailableFields(),gvSearchWidget.selectFields.prop("outerHTML");var fields=gvSearchWidget.widgetTarget.data("gvSelectFields");if(void 0!==fields)return gvSearchWidget.selectFields=$(fields),gvSearchWidget.updateAvailableFields(),$("table",gvSearchWidget.widgetTarget).length?gvSearchWidget.selectFields.prop("outerHTML"):void gvSearchWidget.renderUI(parent);var ajaxdata={action:"gv_searchable_fields",nonce:gvSearchVar.nonce,formid:$("#gravityview_form_id").val(),view_id:$("#gravityview_view_id",parent).val(),template_id:$("#gravityview_directory_template").val()};$.ajax({url:ajaxurl,type:"POST",async:!0,dataType:"html",data:ajaxdata,success:function(response){"0"!==response&&(gvSearchWidget.selectFields=$(response),gvSearchWidget.widgetTarget.data("gvSelectFields",response),gvSearchWidget.renderUI(parent))}})},getSelectInput:function(type){var labels=$.parseJSON(gvSearchVar.input_labels),types=$.parseJSON(gvSearchVar.input_types),options=[],inputs=gvSearchWidget.getValue(types,type);return null===inputs?"":($.each(inputs,function(k,input){var label=gvSearchWidget.getValue(labels,input);options.push('<option value="'+input+'">'+label+"</option>")}),options.join())},getValue:function(obj,key){var value=null;return $.each(obj,function(k,val){return key===k?(value=val,!1):void 0}),value},saveWidget:function(){gvSearchWidget.resetWidgetTarget($(this)),gvSearchWidget.updateOnClose()},updateOnClose:function(){var configs=[];gvSearchWidget.widgetTarget.find("table tr.gv-search-field-row").each(function(){var row={};row.field=$(this).find("select.gv-search-fields").val(),row.input=$(this).find("select.gv-search-inputs").val(),configs.push(row)}),$(".gv-search-fields-value",gvSearchWidget.widgetTarget).val(JSON.stringify(configs))},clearViewSearchData:function(){gvSearchWidget.selectFields=null,$(".gv-search-fields-value").each(function(){$(this).parents("."+gvSearchWidget.wrapClass).find("table").remove(),$(this).val("")})},clearWidgetSearchData:function(){gvSearchWidget.resetWidgetData($(this)),gvSearchWidget.widgetTarget.removeData("gvSelectFields"),$(".gv-search-fields-value",gvSearchWidget.widgetTarget).val("");var widget=gvSearchWidget.widgetTarget.closest("div.widget");$(".hide-on-view-change:visible",widget).slideUp("fast"),""!==$(this).val()&&gvSearchWidget.renderUI(widget)}};$(document).ready(function(){var contextClass=$("body").hasClass("widgets-php")?"gv-widget-search-fields":"gv-dialog-options";gvSearchWidget.init(contextClass)})}(jQuery);